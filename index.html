<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>视频弹幕评论（简化版：词云与单次输入）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial; margin: 40px; background:#fafafa; }
    #container { max-width: 900px; margin: 0 auto; }

    #playBtn { font-size: 18px; padding: 10px 20px; }

    #videoWrap { position: relative; margin-top: 20px; display:none; }
    #video { width: 100%; background:#000; }

    /* 视频结束后的居中弹窗：只显示问题与输入框 */
    #overlay { position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:10; pointer-events:auto; }
    #overlay .card {
      width: min(90%, 520px);
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 30px rgba(0,0,0,.3);
      padding: 20px;
    }
    #overlay h3 { margin: 0 0 12px; font-size: 20px; text-align:center; }
    #overlay .row { display:flex; gap:12px; margin-top: 12px; }
    #overlay input, #overlay textarea, #overlay button { font-size: 16px; }
    #overlay textarea { min-height: 120px; }
    #overlay button { margin-top: 12px; width: 100%; }
    #overlayForm { display:block; } /* 确保弹窗表单可见 */

    /* 状态提示（词云生成中/已生成） */
    #status { color:#666; margin-top:12px; min-height: 20px; }

    /* 词云区域（心跳.jpg 形状 + 返回按钮 + 循环 BGM） */
    #wcWrap { display:none; position: relative; margin-top: 16px; }
    #wordcloudCanvas {
      display: block;
      width: 100%;
      max-width: 900px;
      height: 420px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fff;
    }
    #bgm { display: none; } /* 隐藏音频控件，提交后自动播放 */
    .backBtn {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      z-index: 20;
    }
  </style>
</head>
<body>
  <div id="container">
    <button id="playBtn">播放</button>

    <div id="videoWrap">
      <video id="video" src="video.mp4" controls></video>

      <!-- 视频结束后的居中弹窗 -->
      <div id="overlay">
        <div class="card">
          <h3>你觉得爱是什么</h3>
          <form id="overlayForm">
            <div class="row">
              <input id="overlayAuthor" type="text" placeholder="昵称（可选）" maxlength="128">
            </div>
            <div class="row">
              <textarea id="overlayContent" placeholder="写下你的想法..." maxlength="2000"></textarea>
            </div>
            <button id="overlaySubmit" type="submit">提交</button>
          </form>
        </div>
      </div>
    </div>

    <!-- 状态提示（生成词云时显示进度） -->
    <div id="status"></div>

    <!-- 词云区域：心形掩模 + 返回按钮 + 循环 BGM -->
    <div id="wcWrap">
      <button id="backBtn" class="backBtn">返回</button>
      <canvas id="wordcloudCanvas"></canvas>
      <audio id="bgm" src="快速心跳声.mp3" loop></audio>
    </div>
  </div>

  <script>
    // 基本元素
    const playBtn = document.getElementById('playBtn');
    const videoWrap = document.getElementById('videoWrap');
    const video = document.getElementById('video');

    const overlay = document.getElementById('overlay');
    const overlayForm = document.getElementById('overlayForm');
    const overlayAuthorEl = document.getElementById('overlayAuthor');
    const overlayContentEl = document.getElementById('overlayContent');
    const overlaySubmitBtn = document.getElementById('overlaySubmit');

    const statusEl = document.getElementById('status');

    // 词云与控制元素
    const wcWrap = document.getElementById('wcWrap');
    const wcCanvas = document.getElementById('wordcloudCanvas');
    const backBtn = document.getElementById('backBtn');
    const bgm = document.getElementById('bgm');

    // thread 与“仅一次”标记
    const thread = (location.pathname.replace(/[^a-z0-9/_-]/gi, '_') || '/').toLowerCase();
    const submittedKey = 'submitted:' + thread;

    // 播放按钮：显示视频
    playBtn.addEventListener('click', () => {
      playBtn.style.display = 'none';
      videoWrap.style.display = 'block';
      video.play().catch(() => {});
    });

    // 视频结束：只显示提问卡片
    video.addEventListener('ended', () => {
      overlay.style.display = 'flex';
      // 如果已提交过，禁用输入（只能一次）
      if (localStorage.getItem(submittedKey) === '1') {
        overlayAuthorEl.disabled = true;
        overlayContentEl.disabled = true;
        overlaySubmitBtn.disabled = true;
      }
    });

    // 弹窗提交评论：仅一次，成功后直接进入词云并播放 BGM
    overlayForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const author = overlayAuthorEl.value.trim();
      const content = overlayContentEl.value.trim();
      if (!content) { alert('内容不能为空'); return; }
      overlaySubmitBtn.disabled = true;
      try {
        const at = Math.floor(video.currentTime || 0);
        const resp = await fetch('/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread, author, content, at_seconds: at })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || '提交失败');

        // 标记“仅一次”
        localStorage.setItem(submittedKey, '1');

        // 进入词云：显示、生成并滚动；播放循环心跳
        overlay.style.display = 'none';
        wcWrap.style.display = 'block';
        await genWordCloud(true);
        wcCanvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
        bgm.currentTime = 0;
        bgm.play().catch(() => {});
      } catch (err) {
        alert('提交失败：' + (err.message || err));
      } finally {
        overlaySubmitBtn.disabled = false;
      }
    });

    // 返回按钮：回到问题输入卡片（保持只能一次，禁用输入）
    backBtn.addEventListener('click', () => {
      bgm.pause();
      wcWrap.style.display = 'none';
      overlay.style.display = 'flex';
      overlayAuthorEl.disabled = true;
      overlayContentEl.disabled = true;
      overlaySubmitBtn.disabled = true;
    });

    // 生成词云（心跳.jpg 掩模，统一深红色）
    async function genWordCloud(auto = false) {
      statusEl.textContent = '正在生成词云...';
      const tokens = await collectTokensFromAllComments();
      await renderWordCloudMask(tokens);
      statusEl.textContent = '词云已生成';
      if (!auto) wcCanvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // 拉取全部评论并统计词频
    async function collectTokensFromAllComments() {
      let wcOffset = 0;
      const wcLimit = 100;
      const texts = [];
      while (true) {
        const resp = await fetch(`/comments?thread=${encodeURIComponent(thread)}&limit=${wcLimit}&offset=${wcOffset}`);
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || '拉取失败');
        if (data.items.length === 0) break;
        texts.push(...data.items.map(i => String(i.content || '')));
        wcOffset += data.items.length;
        if (data.items.length < wcLimit) break;
      }
      return buildFrequencies(texts);
    }

    // 简易中文友好分词：英文按词、中文用双字滑窗
    function buildFrequencies(texts) {
      const stop = new Set(['的','了','是','我','你','他','她','它','在','和','与','就','都','很','也','这','那','一个','我们','他们','因为','所以','如果','但是','而且','不是','还有','会','能','把','被','给','让','呢','嘛','吗','啊','哦','呃']);
      const freq = new Map();
      const normalize = s => s.toLowerCase().replace(/[^\p{L}\p{N}\u4e00-\u9fff]+/gu, ' ');
      const add = w => {
        if (!w) return;
        if (stop.has(w)) return;
        if (w.length < 2) return;
        freq.set(w, (freq.get(w) || 0) + 1);
      };
      for (const t of texts) {
        const s = normalize(t);
        const words = s.match(/\p{L}[\p{L}\p{N}_]{1,}/gu) || [];
        words.forEach(add);
        const zhSeqs = s.match(/[\u4e00-\u9fff]+/g) || [];
        zhSeqs.forEach(seq => {
          if (seq.length >= 2) {
            for (let i = 0; i < seq.length - 1; i++) add(seq.slice(i, i + 2));
          }
        });
      }
      const arr = Array.from(freq.entries()).map(([word, count]) => ({ word, count }));
      arr.sort((a, b) => b.count - a.count);
      return arr.slice(0, 120); // 取 Top 120
    }

    // 心形掩模渲染：从心跳.jpg 生成二值掩模并布局文本（统一深红色）
    async function renderWordCloudMask(tokens) {
      const canvas = wcCanvas;
      const ctx = canvas.getContext('2d');
      const W = canvas.clientWidth || 900;
      const H = canvas.clientHeight || 420;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(W * dpr);
      canvas.height = Math.round(H * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, W, H);

      const img = await loadImage('心跳.jpg');
      const off = document.createElement('canvas');
      off.width = W; off.height = H;
      const ictx = off.getContext('2d');
      ictx.drawImage(img, 0, 0, W, H);
      const { data } = ictx.getImageData(0, 0, W, H);

      // 非白区域作为“形状内”（阈值可调）
      const mask = new Uint8Array(W * H);
      for (let y = 0; y < H; y++) {
        for (let x = 0; x < W; x++) {
          const i = (y * W + x) * 4;
          const r = data[i], g = data[i + 1], b = data[i + 2], a = data[i + 3];
          const brightness = 0.2126 * r + 0.7152 * g + 0.0722 * b;
          mask[y * W + x] = (a > 40 && brightness < 240) ? 1 : 0;
        }
      }
      const inside = (x, y) => x >= 0 && y >= 0 && x < W && y < H && mask[y * W + x] === 1;

      // 碰撞格子避免重叠
      const cell = 18;
      const cols = Math.ceil(W / cell), rows = Math.ceil(H / cell);
      const grid = Array.from({ length: rows }, () => Array(cols).fill(0));
      const occupy = (x, y, w, h) => {
        const c0 = Math.max(0, Math.floor(x / cell)), r0 = Math.max(0, Math.floor(y / cell));
        const c1 = Math.min(cols - 1, Math.floor((x + w) / cell)), r1 = Math.min(rows - 1, Math.floor((y + h) / cell));
        for (let r = r0; r <= r1; r++) for (let c = c0; c <= c1; c++) if (grid[r][c]) return false;
        for (let r = r0; r <= r1; r++) for (let c = c0; c <= c1; c++) grid[r][c] = 1;
        return true;
      };

      const deepRed = '#8B0000';
      const max = tokens.length ? tokens[0].count : 1;
      const min = tokens.length ? tokens[tokens.length - 1].count : 1;
      const fontSize = c => {
        const t = (c - min) / Math.max(1, (max - min));
        return Math.round(14 + t * 38); // 14px ~ 52px
      };

      function sampleInside() {
        for (let k = 0; k < 800; k++) {
          const x = Math.floor(Math.random() * W);
          const y = Math.floor(Math.random() * H);
          if (inside(x, y)) return { x, y };
        }
        return { x: Math.floor(W / 2), y: Math.floor(H / 2) };
      }

      tokens.sort((a, b) => b.count - a.count);
      tokens.forEach((t) => {
        const size = fontSize(t.count);
        ctx.font = `bold ${size}px system-ui, -apple-system, Segoe UI, Arial`;
        const text = t.word;
        const w = Math.ceil(ctx.measureText(text).width);
        const h = Math.ceil(size * 1.2);
        let placed = false;
        for (let tries = 0; tries < 250 && !placed; tries++) {
          const p = sampleInside();
          const x = Math.round(p.x - w / 2);
          const y = Math.round(p.y - h / 2);
          if (x < 0 || y < 0 || x + w >= W || y + h >= H) continue;
          // 检查中心与四角在掩模内，避免出界
          if (!inside(p.x, p.y) || !inside(x, y) || !inside(x + w, y) || !inside(x, y + h) || !inside(x + w, y + h)) continue;
          if (!occupy(x, y, w, h)) continue;
          ctx.fillStyle = deepRed;
          ctx.fillText(text, x, y + h * 0.8);
          placed = true;
        }
      });
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }
  </script>
</body>
</html>