<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>视频弹幕评论（Render + Neon）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial; margin: 40px; background:#fafafa; }
    #container { max-width: 900px; margin: 0 auto; }
    #playBtn { font-size: 18px; padding: 10px 20px; }
    #videoWrap { position: relative; margin-top: 20px; display:none; }
    #video { width: 100%; background:#000; }
    #danmakuLayer { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .dm { position:absolute; right:-20%; color:#fff; font-weight:600; text-shadow: 1px 1px 2px #000;
          white-space:nowrap; will-change:transform, opacity; animation: dm-move linear 8s forwards; }
    @keyframes dm-move { 0% { transform: translateX(0); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateX(-140%); opacity: 0; } }

    #gate { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; display:none; }
    #gate button { margin-right: 8px; padding: 8px 14px; }

    form { display:none; gap:12px; margin: 16px 0; }
    input, textarea, button { font-size: 16px; }
    input, textarea { padding: 10px; border:1px solid #ddd; border-radius:8px; flex:1; }
    textarea { min-height: 100px; }
    button { padding: 10px 16px; border: none; border-radius: 8px; background: #2962ff; color:#fff; cursor:pointer; }
    button:disabled { background:#999; cursor:not-allowed; }

    #status { color:#666; margin-top:12px; }
    #list .item { border-bottom:1px solid #eee; padding:12px 0; }
    .meta { color:#666; font-size:14px; }
    .content { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="container">
    <button id="playBtn">播放</button>

    <div id="videoWrap">
      <video id="video" src="video.mp4" controls></video>
      <div id="danmakuLayer"></div>
    </div>

    <div id="gate">
      <p>视频播放完毕，请选择：</p>
      <button id="gateWatchBtn">我已观看</button>
      <button id="gateContinueBtn">继续学习</button>
      <button id="unlockBtn">开始评论</button>
    </div>

    <form id="commentForm">
      <input id="author" type="text" placeholder="昵称（可选）" maxlength="128">
      <textarea id="content" placeholder="说点什么..." maxlength="2000"></textarea>
      <button id="submitBtn" type="submit">提交</button>
    </form>

    <div id="status">尚未加载</div>
    <div id="list"></div>
    <div style="margin-top:12px;">
      <button id="moreBtn" style="background:#555;">加载更多</button>
    </div>
  </div>

  <script>
    const playBtn = document.getElementById('playBtn');
    const videoWrap = document.getElementById('videoWrap');
    const video = document.getElementById('video');
    const danmakuLayer = document.getElementById('danmakuLayer');

    const gate = document.getElementById('gate');
    const unlockBtn = document.getElementById('unlockBtn');

    const formEl = document.getElementById('commentForm');
    const authorEl = document.getElementById('author');
    const contentEl = document.getElementById('content');
    const submitBtn = document.getElementById('submitBtn');

    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const moreBtn = document.getElementById('moreBtn');

    const thread = (location.pathname.replace(/[^a-z0-9/_-]/gi, '_') || '/').toLowerCase();
    let offset = 0, limit = 20, loading = false, done = false;
    let dmIndexBySec = new Map();
    let shownById = new Set();

    playBtn.addEventListener('click', () => {
      playBtn.style.display = 'none';
      videoWrap.style.display = 'block';
      video.play().catch(() => {});
    });

    video.addEventListener('ended', () => {
      gate.style.display = 'block';
    });

    unlockBtn.addEventListener('click', () => {
      formEl.style.display = 'flex';
      statusEl.textContent = '评论已解锁';
    });

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const author = authorEl.value.trim();
      const content = contentEl.value.trim();
      if (!content) { alert('内容不能为空'); return; }
      submitBtn.disabled = true;
      try {
        const at = Math.floor(video.currentTime || 0);
        const resp = await fetch('/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread, author, content, at_seconds: at })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || '提交失败');
        listEl.insertAdjacentHTML('afterbegin', renderItem(data.item));
        contentEl.value = '';
        statusEl.textContent = '提交成功';
        showDanmakuNow(data.item);
      } catch (err) {
        statusEl.textContent = '提交失败：' + (err.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    moreBtn.addEventListener('click', () => {
      if (done || loading) return;
      loadComments();
    });

    async function loadComments() {
      loading = true;
      statusEl.textContent = '正在加载评论...';
      try {
        const resp = await fetch(`/comments?thread=${encodeURIComponent(thread)}&limit=${limit}&offset=${offset}`);
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || '拉取失败');
        if (data.items.length === 0) { done = true; moreBtn.disabled = true; statusEl.textContent = '没有更多了'; return; }
        data.items.forEach(item => {
          listEl.insertAdjacentHTML('beforeend', renderItem(item));
          if (Number.isFinite(item.at_seconds)) {
            const sec = item.at_seconds;
            if (!dmIndexBySec.has(sec)) dmIndexBySec.set(sec, []);
            dmIndexBySec.get(sec).push(item);
          }
        });
        offset += data.items.length;
        statusEl.textContent = `已加载 ${offset} 条`;
      } catch (err) {
        statusEl.textContent = '加载失败：' + (err.message || err);
      } finally {
        loading = false;
      }
    }

    function renderItem(item) {
      const author = item.author ? escapeHtml(item.author) : '匿名';
      const content = escapeHtml(item.content || '');
      const time = formatTime(item.created_at);
      const atText = Number.isFinite(item.at_seconds) ? ` · 弹幕于 ${item.at_seconds}s` : '';
      return `
        <div class="item">
          <div class="meta">${author} · ${time}${atText}</div>
          <div class="content">${content}</div>
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function formatTime(t) {
      try { return new Date(t).toLocaleString(); } catch { return String(t); }
    }

    function showDanmakuNow(item) {
      const y = pickY();
      const el = document.createElement('div');
      el.className = 'dm';
      el.style.top = y + 'px';
      el.textContent = item.content || '';
      danmakuLayer.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    }

    function pickY() {
      const h = danmakuLayer.clientHeight || 300;
      const lines = Math.max(6, Math.floor(h / 28));
      const line = Math.floor(Math.random() * lines);
      return Math.min(h - 24, Math.max(0, line * 24));
    }

    video.addEventListener('timeupdate', () => {
      const sec = Math.floor(video.currentTime || 0);
      const items = dmIndexBySec.get(sec) || [];
      items.forEach(item => {
        if (shownById.has(item.id)) return;
        shownById.add(item.id);
        showDanmakuNow(item);
      });
    });

    loadComments();
  </script>
</body>
</html>