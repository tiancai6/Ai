<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è§†é¢‘å¼¹å¹•è¯„è®ºï¼ˆRender + Neonï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial; margin: 40px; background:#fafafa; }
    #container { max-width: 900px; margin: 0 auto; }
    #playBtn { font-size: 18px; padding: 10px 20px; }
    #videoWrap { position: relative; margin-top: 20px; display:none; }
    #video { width: 100%; background:#000; }
    #danmakuLayer { position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .dm { position:absolute; right:-20%; color:#fff; font-weight:600; text-shadow: 1px 1px 2px #000;
          white-space:nowrap; will-change:transform, opacity; animation: dm-move linear 8s forwards; }
    @keyframes dm-move { 0% { transform: translateX(0); opacity: 1; } 90% { opacity: 1; } 100% { transform: translateX(-140%); opacity: 0; } }

    #gate { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; display:none; }
    #gate button { margin-right: 8px; padding: 8px 14px; }

    form { display:none; gap:12px; margin: 16px 0; }
    input, textarea, button { font-size: 16px; }
    input, textarea { padding: 10px; border:1px solid #ddd; border-radius:8px; flex:1; }
    textarea { min-height: 100px; }
    button { padding: 10px 16px; border: none; border-radius: 8px; background: #2962ff; color:#fff; cursor:pointer; }
    button:disabled { background:#999; cursor:not-allowed; }

    #status { color:#666; margin-top:12px; }
    #list .item { border-bottom:1px solid #eee; padding:12px 0; }
    .meta { color:#666; font-size:14px; }
    .content { white-space: pre-wrap; }

    /* ç‚¹èµæŒ‰é’®æ ·å¼ */
    .likeBtn {
      margin-left: 12px;
      font-size: 14px;
      padding: 2px 8px;
      border: 1px solid #ddd;
      border-radius: 14px;
      background: #fff;
      color: #333;
      cursor: pointer;
    }
    .likeBtn[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    /* é¦–æ¬¡è®¿é—®ï¼šéšè—è¯„è®ºåˆ—è¡¨ä¸â€œåŠ è½½æ›´å¤šâ€ */
    #list, #moreBtn { display: none; }
  </style>
</head>
<body>
  <div id="container">
    <button id="playBtn">æ’­æ”¾</button>

    <div id="videoWrap">
      <video id="video" src="video.mp4" controls></video>
      <div id="danmakuLayer"></div>
    </div>

    <div id="gate">
      <p>è§†é¢‘æ’­æ”¾å®Œæ¯•ï¼Œè¯·é€‰æ‹©ï¼š</p>
      <button id="gateWatchBtn">æˆ‘å·²è§‚çœ‹</button>
      <button id="gateContinueBtn">ç»§ç»­å­¦ä¹ </button>
      <button id="unlockBtn">å¼€å§‹è¯„è®º</button>
    </div>

    <form id="commentForm">
      <input id="author" type="text" placeholder="æ˜µç§°ï¼ˆå¯é€‰ï¼‰" maxlength="128">
      <textarea id="content" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." maxlength="2000"></textarea>
      <button id="submitBtn" type="submit">æäº¤</button>
    </form>

    <div id="status">å°šæœªåŠ è½½</div>
    <div id="list"></div>
    <div style="margin-top:12px;">
      <button id="moreBtn" style="background:#555;">åŠ è½½æ›´å¤š</button>
    </div>
  </div>

  <script>
    const playBtn = document.getElementById('playBtn');
    const videoWrap = document.getElementById('videoWrap');
    const video = document.getElementById('video');
    const danmakuLayer = document.getElementById('danmakuLayer');

    const gate = document.getElementById('gate');
    const unlockBtn = document.getElementById('unlockBtn');

    const formEl = document.getElementById('commentForm');
    const authorEl = document.getElementById('author');
    const contentEl = document.getElementById('content');
    const submitBtn = document.getElementById('submitBtn');

    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const moreBtn = document.getElementById('moreBtn');

    const thread = (location.pathname.replace(/[^a-z0-9/_-]/gi, '_') || '/').toLowerCase();
    let offset = 0, limit = 20, loading = false, done = false;
    let dmIndexBySec = new Map();
    let shownById = new Set();
    let danmakuEnabled = false; // é¦–æ¬¡ä¸å±•ç¤ºå†å²å¼¹å¹•ï¼Œè¯„è®ºæˆåŠŸåå¼€å¯

    playBtn.addEventListener('click', () => {
      playBtn.style.display = 'none';
      videoWrap.style.display = 'block';
      video.play().catch(() => {});
    });

    video.addEventListener('ended', () => {
      gate.style.display = 'block';
    });

    unlockBtn.addEventListener('click', () => {
      formEl.style.display = 'flex';
      statusEl.textContent = 'è¯„è®ºå·²è§£é”';
    });

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const author = authorEl.value.trim();
      const content = contentEl.value.trim();
      if (!content) { alert('å†…å®¹ä¸èƒ½ä¸ºç©º'); return; }
      submitBtn.disabled = true;
      try {
        const at = Math.floor(video.currentTime || 0);
        const resp = await fetch('/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thread, author, content, at_seconds: at })
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || 'æäº¤å¤±è´¥');

        // å…ˆæ˜¾ç¤ºè‡ªå·±çš„è¯„è®ºä¸å¼¹å¹•ï¼ˆå…è®¸çœ‹åˆ°è‡ªå·±åˆšå‘çš„é‚£æ¡ï¼‰
        listEl.insertAdjacentHTML('afterbegin', renderItem(data.item));
        contentEl.value = '';
        statusEl.textContent = 'æäº¤æˆåŠŸ';
        showDanmakuNow(data.item);

        // ç„¶åå†æ˜¾ç¤ºæ‰€æœ‰è¯„è®ºå¹¶å¼€å¯å†å²å¼¹å¹•
        revealCommentsAndDanmaku();
      } catch (err) {
        statusEl.textContent = 'æäº¤å¤±è´¥ï¼š' + (err.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });

    moreBtn.addEventListener('click', () => {
      if (done || loading) return;
      loadComments();
    });

    async function loadComments() {
      loading = true;
      statusEl.textContent = 'æ­£åœ¨åŠ è½½è¯„è®º...';
      try {
        const resp = await fetch(`/comments?thread=${encodeURIComponent(thread)}&limit=${limit}&offset=${offset}`);
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || 'æ‹‰å–å¤±è´¥');
        if (data.items.length === 0) { done = true; moreBtn.disabled = true; statusEl.textContent = 'æ²¡æœ‰æ›´å¤šäº†'; return; }
        data.items.forEach(item => {
          // é¿å…é‡å¤æ¸²æŸ“ï¼šå¦‚æœå·²å­˜åœ¨è¯¥è¯„è®ºçš„å…ƒç´ åˆ™è·³è¿‡
          if (!document.querySelector(`.item[data-id="${item.id}"]`)) {
            listEl.insertAdjacentHTML('beforeend', renderItem(item));
          }
          // ä¸ºå†å²å¼¹å¹•å»ºç«‹ç´¢å¼•ï¼ˆä»…åœ¨å¼€å¯åç”¨äº timeupdateï¼‰
          if (Number.isFinite(item.at_seconds)) {
            const sec = item.at_seconds;
            if (!dmIndexBySec.has(sec)) dmIndexBySec.set(sec, []);
            dmIndexBySec.get(sec).push(item);
          }
        });
        offset += data.items.length;
        statusEl.textContent = `å·²åŠ è½½ ${offset} æ¡`;
      } catch (err) {
        statusEl.textContent = 'åŠ è½½å¤±è´¥ï¼š' + (err.message || err);
      } finally {
        loading = false;
      }
    }

    function isLiked(id) {
      return localStorage.getItem('liked:' + id) === '1';
    }
    function renderItem(item) {
      const author = item.author ? escapeHtml(item.author) : 'åŒ¿å';
      const content = escapeHtml(item.content || '');
      const time = formatTime(item.created_at);
      const atText = Number.isFinite(item.at_seconds) ? ` Â· å¼¹å¹•äº ${item.at_seconds}s` : '';
      const likedAttr = isLiked(item.id) ? 'disabled' : '';
      return `
        <div class="item" data-id="${item.id}">
          <div class="meta">${author} Â· ${time}${atText}
            <button class="likeBtn" ${likedAttr} title="ç‚¹èµ">
              ğŸ‘ <span class="likeCount">${item.likes_count || 0}</span>
            </button>
          </div>
          <div class="content">${content}</div>
        </div>
      `;
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function formatTime(t) {
      try { return new Date(t).toLocaleString(); } catch { return String(t); }
    }

    function showDanmakuNow(item) {
      const y = pickY();
      const el = document.createElement('div');
      el.className = 'dm';
      el.style.top = y + 'px';
      el.textContent = item.content || '';
      danmakuLayer.appendChild(el);
      el.addEventListener('animationend', () => el.remove());
    }

    function pickY() {
      const h = danmakuLayer.clientHeight || 300;
      const lines = Math.max(6, Math.floor(h / 28));
      const line = Math.floor(Math.random() * lines);
      return Math.min(h - 24, Math.max(0, line * 24));
    }

    video.addEventListener('timeupdate', () => {
      if (!danmakuEnabled) return; // é¦–æ¬¡ä¸æ˜¾ç¤ºå†å²å¼¹å¹•
      const sec = Math.floor(video.currentTime || 0);
      const items = dmIndexBySec.get(sec) || [];
      items.forEach(item => {
        if (shownById.has(item.id)) return;
        shownById.add(item.id);
        showDanmakuNow(item);
      });
    });

    // æäº¤è¯„è®ºæˆåŠŸåï¼Œå±•ç¤ºè¯„è®ºä¸å¼€å¯å†å²å¼¹å¹•
    function revealCommentsAndDanmaku() {
      listEl.style.display = 'block';
      moreBtn.style.display = 'inline-block';
      danmakuEnabled = true;
      // é‡ç½®å¹¶åŠ è½½è¯„è®º
      offset = 0; done = false; dmIndexBySec.clear(); shownById.clear();
      loadComments();
    }

    // ä¸è¦åœ¨é¦–æ¬¡åŠ è½½æ—¶æ‹‰å–è¯„è®ºï¼Œä¿æŒéšè—ç›´åˆ°è¯„è®ºæˆåŠŸ
  </script>
</body>
</html>